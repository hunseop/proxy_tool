{% raw %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>PPAT 관리</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
<div id="app" class="container mx-auto p-4">
    <!-- 네비게이션 -->
    <div class="mb-4">
        <button class="mr-2" :class="tab==='proxy' ? 'font-bold' : ''" @click="tab='proxy'">프록시 관리</button>
        <button class="mr-2" :class="tab==='resource' ? 'font-bold' : ''" @click="tab='resource'">리소스 모니터</button>
        <button :class="tab==='session' ? 'font-bold' : ''" @click="tab='session'">세션 모니터</button>
    </div>

    <!-- 프록시 관리 -->
    <div v-if="tab==='proxy'" class="space-y-8">
        <!-- 그룹 관리 -->
        <div class="bg-white p-4 rounded shadow">
            <h2 class="font-semibold mb-2">그룹 관리</h2>
            <form @submit.prevent="saveGroup" class="flex flex-wrap items-end space-x-2 mb-4">
                <input v-model="groupForm.name" placeholder="이름" class="border p-1" required>
                <input v-model="groupForm.description" placeholder="설명" class="border p-1 flex-grow">
                <button type="submit" class="bg-blue-500 text-white px-3 py-1 rounded">{{ groupForm.id ? '수정' : '추가' }}</button>
                <button v-if="groupForm.id" type="button" @click="resetGroup" class="px-2 py-1">취소</button>
            </form>
            <table class="min-w-full text-sm">
                <thead>
                    <tr class="bg-gray-50">
                        <th class="px-2 py-1 text-left">ID</th>
                        <th class="px-2 py-1 text-left">이름</th>
                        <th class="px-2 py-1 text-left">설명</th>
                        <th class="px-2 py-1">서버수</th>
                        <th class="px-2 py-1">작업</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="g in groups" :key="g.id" class="border-t">
                        <td class="px-2 py-1">{{ g.id }}</td>
                        <td class="px-2 py-1">{{ g.name }}</td>
                        <td class="px-2 py-1">{{ g.description }}</td>
                        <td class="px-2 py-1 text-center">{{ g.proxy_count }}</td>
                        <td class="px-2 py-1 text-center space-x-1">
                            <button @click="editGroup(g)" class="text-blue-600">수정</button>
                            <button @click="deleteGroup(g.id)" class="text-red-600">삭제</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- 서버 관리 -->
        <div class="bg-white p-4 rounded shadow">
            <h2 class="font-semibold mb-2">서버 관리</h2>
            <form @submit.prevent="saveServer" class="flex flex-wrap items-end space-x-2 mb-4">
                <input v-model="serverForm.name" placeholder="이름" class="border p-1" required>
                <input v-model="serverForm.ip_address" placeholder="IP" class="border p-1" required>
                <input v-model.number="serverForm.port" type="number" placeholder="포트" class="border p-1 w-24" required>
                <select v-model.number="serverForm.group_id" class="border p-1">
                    <option disabled value="">그룹 선택</option>
                    <option v-for="g in groups" :key="g.id" :value="g.id">{{ g.name }}</option>
                </select>
                <label class="ml-2"><input type="checkbox" v-model="serverForm.is_main"> 메인</label>
                <label class="ml-2"><input type="checkbox" v-model="serverForm.enabled"> 활성</label>
                <button type="submit" class="bg-blue-500 text-white px-3 py-1 rounded">{{ serverForm.id ? '수정' : '추가' }}</button>
                <button v-if="serverForm.id" type="button" @click="resetServer" class="px-2 py-1">취소</button>
            </form>
            <table class="min-w-full text-sm">
                <thead>
                    <tr class="bg-gray-50">
                        <th class="px-2 py-1 text-left">ID</th>
                        <th class="px-2 py-1 text-left">이름</th>
                        <th class="px-2 py-1 text-left">IP</th>
                        <th class="px-2 py-1">포트</th>
                        <th class="px-2 py-1">그룹</th>
                        <th class="px-2 py-1">상태</th>
                        <th class="px-2 py-1">작업</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="s in servers" :key="s.id" class="border-t">
                        <td class="px-2 py-1">{{ s.id }}</td>
                        <td class="px-2 py-1">{{ s.name }}</td>
                        <td class="px-2 py-1">{{ s.ip_address }}</td>
                        <td class="px-2 py-1 text-center">{{ s.port }}</td>
                        <td class="px-2 py-1">{{ s.group_name }}</td>
                        <td class="px-2 py-1 text-center">{{ s.enabled ? '활성' : '비활성' }}</td>
                        <td class="px-2 py-1 text-center space-x-1">
                            <button @click="editServer(s)" class="text-blue-600">수정</button>
                            <button @click="deleteServer(s.id)" class="text-red-600">삭제</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- 리소스 모니터 -->
    <div v-if="tab==='resource'" class="bg-white p-4 rounded shadow space-y-4">
        <div class="flex flex-wrap items-end space-x-2">
            <select v-model.number="filterGroup" class="border p-1">
                <option value="">그룹 선택</option>
                <option v-for="g in groups" :key="g.id" :value="g.id">{{ g.name }}</option>
            </select>
            <select v-model.number="filterServer" class="border p-1">
                <option value="">서버 선택</option>
                <option v-for="s in servers" :key="s.id" :value="s.id">{{ s.name }}</option>
            </select>
            <input v-model.number="interval" type="number" class="border p-1 w-20" min="1">초
            <button @click="setIntervalApi" class="px-2 py-1 border">주기 설정</button>
            <button @click="startMonitoring" class="px-2 py-1 bg-blue-500 text-white">시작</button>
            <button @click="stopMonitoring" class="px-2 py-1 bg-gray-300">중지</button>
            <button @click="loadResources" class="px-2 py-1 border">새로고침</button>
        </div>
        <table class="min-w-full text-sm">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-2 py-1">시간</th>
                    <th class="px-2 py-1">서버</th>
                    <th class="px-2 py-1">CPU %</th>
                    <th class="px-2 py-1">Memory %</th>
                    <th class="px-2 py-1">Unique</th>
                    <th class="px-2 py-1">CC</th>
                    <th class="px-2 py-1">CS</th>
                    <th class="px-2 py-1">HTTP</th>
                    <th class="px-2 py-1">HTTPS</th>
                    <th class="px-2 py-1">FTP</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="r in resources" :key="r.id" class="border-t">
                    <td class="px-2 py-1">{{ r.timestamp }}</td>
                    <td class="px-2 py-1">{{ r.proxy_id }}</td>
                    <td class="px-2 py-1">{{ r.cpu }}</td>
                    <td class="px-2 py-1">{{ r.memory }}</td>
                    <td class="px-2 py-1">{{ r.unique_clients }}</td>
                    <td class="px-2 py-1">{{ r.cc }}</td>
                    <td class="px-2 py-1">{{ r.cs }}</td>
                    <td class="px-2 py-1">{{ r.http }}</td>
                    <td class="px-2 py-1">{{ r.https }}</td>
                    <td class="px-2 py-1">{{ r.ftp }}</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- 세션 모니터 -->
    <div v-if="tab==='session'" class="bg-white p-4 rounded shadow space-y-4">
        <div class="flex flex-wrap items-end space-x-2">
            <select v-model.number="sessionServer" class="border p-1">
                <option value="">서버 선택</option>
                <option v-for="s in servers" :key="s.id" :value="s.id">{{ s.name }}</option>
            </select>
            <input v-model="search" placeholder="검색" class="border p-1">
            <button @click="loadSessions" class="px-2 py-1 border">조회</button>
        </div>
        <table class="min-w-full text-sm">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-2 py-1">데이터</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="(s, idx) in sessions" :key="idx" class="border-t">
                    <td class="px-2 py-1 text-xs whitespace-pre">{{ JSON.stringify(s) }}</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
const { createApp, ref, onMounted } = Vue;
createApp({
    setup() {
        const tab = ref('proxy');
        const groups = ref([]);
        const servers = ref([]);
        const groupForm = ref({id:null,name:'',description:''});
        const serverForm = ref({id:null,name:'',ip_address:'',port:0,group_id:'',is_main:false,enabled:true});
        const resources = ref([]);
        const sessions = ref([]);
        const filterGroup = ref('');
        const filterServer = ref('');
        const sessionServer = ref('');
        const search = ref('');
        const interval = ref(60);

        const loadGroups = async () => {
            const res = await fetch('/api/proxy/groups');
            groups.value = await res.json();
        };
        const loadServers = async () => {
            const res = await fetch('/api/proxy/servers');
            const data = await res.json();
            servers.value = data.map(s => ({...s, group_name: groups.value.find(g => g.id===s.group_id)?.name || ''}));
        };
        const resetGroup = () => { groupForm.value = {id:null,name:'',description:''}; };
        const resetServer = () => { serverForm.value = {id:null,name:'',ip_address:'',port:0,group_id:'',is_main:false,enabled:true}; };
        const saveGroup = async () => {
            if(groupForm.value.id){
                await fetch(`/api/proxy/groups/${groupForm.value.id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(groupForm.value)});
            }else{
                await fetch('/api/proxy/groups',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(groupForm.value)});
            }
            resetGroup();
            await loadGroups();
            await loadServers();
        };
        const editGroup = g => { groupForm.value = {...g}; };
        const deleteGroup = async id => { if(confirm('삭제하시겠습니까?')){ await fetch(`/api/proxy/groups/${id}`,{method:'DELETE'}); await loadGroups(); await loadServers(); } };
        const saveServer = async () => {
            const payload = {...serverForm.value};
            if(serverForm.value.id){
                await fetch(`/api/proxy/servers/${serverForm.value.id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
            }else{
                await fetch('/api/proxy/servers',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
            }
            resetServer();
            await loadServers();
        };
        const editServer = s => { serverForm.value = {...s}; };
        const deleteServer = async id => { if(confirm('삭제하시겠습니까?')){ await fetch(`/api/proxy/servers/${id}`,{method:'DELETE'}); await loadServers(); } };

        const loadResources = async () => {
            const params = new URLSearchParams();
            if(filterGroup.value) params.append('group', filterGroup.value);
            if(filterServer.value) params.append('proxy', filterServer.value);
            const res = await fetch(`/api/monitoring/resources?${params}`);
            resources.value = await res.json();
        };
        const startMonitoring = async () => { await fetch('/api/monitoring/start',{method:'POST'}); };
        const stopMonitoring = async () => { await fetch('/api/monitoring/stop',{method:'POST'}); };
        const setIntervalApi = async () => { await fetch('/api/monitoring/interval',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({interval:interval.value})}); };

        const loadSessions = async () => {
            const params = new URLSearchParams();
            if(sessionServer.value) params.append('proxy', sessionServer.value);
            if(search.value) params.append('search', search.value);
            const res = await fetch(`/api/monitoring/sessions?${params}`);
            sessions.value = await res.json();
        };

        onMounted(async () => {
            await loadGroups();
            await loadServers();
            await loadResources();
        });

        const socket = io();
        socket.on('resource_update', data => { resources.value.unshift(data); });
        socket.on('session_update', data => { sessions.value = data; });

        return { tab, groups, servers, groupForm, serverForm, resources, sessions, filterGroup, filterServer, interval, sessionServer, search,
            saveGroup, editGroup, deleteGroup, resetGroup,
            saveServer, editServer, deleteServer, resetServer,
            loadResources, startMonitoring, stopMonitoring, setIntervalApi, loadSessions };
    }
}).mount('#app');
</script>
</body>
</html>
{% endraw %}
